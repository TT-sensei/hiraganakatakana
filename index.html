<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¬¼ã‚³ãƒ¼ãƒã®ç·´ç¿’å¸³</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            background-color: #f0f4f8;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        h1 { margin: 10px 0; color: #333; font-size: 1.5rem; }

        .canvas-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 10px;
        }

        #bgCanvas {
            z-index: 1;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 4px solid #888;
        }

        #drawingCanvas {
            z-index: 2;
            cursor: crosshair;
        }

        /* åˆ¤å®šçµæœã®è¡¨ç¤º */
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            text-shadow: 2px 2px 0 #fff;
            white-space: nowrap;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button.secondary { background-color: #f44336; }
        
        #checkCanvas { display: none; }
    </style>
</head>
<body>

    <h1>ã‹ãã‹ãŸã‚Œã‚“ã—ã‚…ã†ï¼ˆå³ã—ã‚ï¼‰</h1>
    <div style="margin-bottom:10px; font-weight:bold; color:#555;">ç·šã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«æ›¸ã„ã¦ã­</div>

    <div class="canvas-wrapper">
        <canvas id="bgCanvas" width="300" height="300"></canvas>
        <canvas id="drawingCanvas" width="300" height="300"></canvas>
        <div id="message"></div>
    </div>

    <canvas id="checkCanvas" width="300" height="300"></canvas>

    <div class="controls">
        <button class="secondary" onclick="resetCanvas()">ã‚„ã‚ŠãªãŠã—</button>
        <button onclick="nextChar()">ã¤ãã¸ ï¼</button>
    </div>

    <script>
        const drawingCanvas = document.getElementById('drawingCanvas');
        const bgCanvas = document.getElementById('bgCanvas');
        const checkCanvas = document.getElementById('checkCanvas');
        const messageEl = document.getElementById('message');
        
        const ctxDraw = drawingCanvas.getContext('2d');
        const ctxBg = bgCanvas.getContext('2d');
        const ctxCheck = checkCanvas.getContext('2d');
        
        const chars = ["ã‚","ã„","ã†","ãˆ","ãŠ"];
        let currentIndex = 0;
        let isDrawing = false;
        let hasScored = false;

        init();

        function init() {
            drawGuide();
            setupEvents();
        }

        function setupEvents() {
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            drawingCanvas.addEventListener('touchstart', startDrawing, {passive: false});
            drawingCanvas.addEventListener('touchmove', draw, {passive: false});
            drawingCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            e.preventDefault();
            if(hasScored) return;
            isDrawing = true;
            ctxDraw.beginPath();
            const pos = getPos(e);
            ctxDraw.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            
            // â˜…å¤‰æ›´ç‚¹1ï¼šç·šã‚’ç´°ãã—ã¾ã—ãŸï¼ˆ25 -> 12ï¼‰
            ctxDraw.lineWidth = 12; 
            ctxDraw.lineCap = 'round';
            ctxDraw.lineJoin = 'round';
            ctxDraw.strokeStyle = 'rgba(0, 0, 0, 0.9)';
            
            ctxDraw.lineTo(pos.x, pos.y);
            ctxDraw.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                checkResult();
            }
        }

        function getPos(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        function drawGuide() {
            const char = chars[currentIndex];
            
            // èƒŒæ™¯ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆã‚‹ã‚¬ã‚¤ãƒ‰ï¼‰
            ctxBg.clearRect(0,0,300,300);
            
            // åå­—ç·š
            ctxBg.strokeStyle = '#eee';
            ctxBg.beginPath(); ctxBg.moveTo(150, 0); ctxBg.lineTo(150, 300); ctxBg.stroke();
            ctxBg.beginPath(); ctxBg.moveTo(0, 150); ctxBg.lineTo(300, 150); ctxBg.stroke();

            ctxBg.font = "200px 'KaiTi', 'Kyokasho', serif";
            ctxBg.textAlign = "center";
            ctxBg.textBaseline = "middle";
            
            // â˜…å¤‰æ›´ç‚¹2ï¼šã‚¬ã‚¤ãƒ‰ã‚’ã€Œé“ã€ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã€å°‘ã—å¤ªã‚ã«æç”»
            ctxBg.lineWidth = 35; 
            ctxBg.lineJoin = "round";
            ctxBg.strokeStyle = "#e0e0e0"; // é“ã®è‰²
            ctxBg.strokeText(char, 150, 170);

            // åˆ¤å®šç”¨ï¼ˆè£æ–¹ï¼‰
            // èµ¤è‰²ã§ã€Œã“ã“ãªã‚‰æ­£è§£ã€ã¨ã„ã†ã‚¨ãƒªã‚¢ã‚’å¡—ã‚‹
            ctxCheck.clearRect(0,0,300,300);
            ctxCheck.font = "200px 'KaiTi', 'Kyokasho', serif";
            ctxCheck.textAlign = "center";
            ctxCheck.textBaseline = "middle";
            ctxCheck.lineWidth = 40; // åˆ¤å®šã‚¨ãƒªã‚¢ã¯å°‘ã—åºƒã‚ã«ï¼ˆéŠã³ã‚’æŒãŸã›ã‚‹ï¼‰
            ctxCheck.lineJoin = "round";
            ctxCheck.strokeStyle = "#FF0000"; 
            ctxCheck.strokeText(char, 150, 170);
        }

        // â˜…â˜…â˜… å³æ ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function checkResult() {
            if(hasScored) return;

            const guideData = ctxCheck.getImageData(0, 0, 300, 300).data;
            const userData = ctxDraw.getImageData(0, 0, 300, 300).data;

            let hitCount = 0;    // æ­£è§£ã‚¨ãƒªã‚¢ã‚’å¡—ã£ãŸæ•°
            let missCount = 0;   // ã¯ã¿å‡ºã—æ•°
            let guidePixels = 0; // æ­£è§£ã‚¨ãƒªã‚¢ã®ç·é¢ç©

            for (let i = 0; i < guideData.length; i += 4 * 2) { // *2ã§å°‘ã—ç²¾å¯†ã«
                const isRed = guideData[i] > 100;       // ãã“ã¯æ­£è§£ã‚¨ãƒªã‚¢ã‹
                const isPainted = userData[i+3] > 50;   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¡—ã£ãŸã‹

                if (isRed) {
                    guidePixels++;
                    if (isPainted) hitCount++;
                } else {
                    // èµ¤ããªã„å ´æ‰€ï¼ˆç™½ç´™ï¼‰ãªã®ã«å¡—ã£ã¦ãŸã‚‰ãƒšãƒŠãƒ«ãƒ†ã‚£
                    if (isPainted) missCount++;
                }
            }

            // ã‚¹ã‚³ã‚¢è¨ˆç®—
            // å¡—ã‚Šã¤ã¶ã—ç‡ (0.0 ~ 1.0)
            const coverage = hitCount / guidePixels;
            
            // ã¯ã¿å‡ºã—ç‡ï¼ˆå¡—ã£ãŸé‡ã«å¯¾ã—ã¦ã©ã‚Œãã‚‰ã„ã¯ã¿å‡ºã—ãŸã‹ï¼‰
            // ãƒŸã‚¹ãŒè¨±ã•ã‚Œã‚‹ã®ã¯å…¨ä½“ã®ç”»ç´ æ•°ã®ã”ãä¸€éƒ¨
            const missRatio = missCount / (hitCount + 1); 

            console.log(`ã‚«ãƒãƒ¼ç‡:${Math.floor(coverage*100)}% ã¯ã¿å‡ºã—:${Math.floor(missRatio*100)}%`);

            // åˆ¤å®šåŸºæº–
            // 1. ãŠæ‰‹æœ¬ã®50%ä»¥ä¸Šã‚’ãªãã£ã¦ã„ã‚‹ã“ã¨
            // 2. ã¯ã¿å‡ºã—ãŒãŠæ‰‹æœ¬ã‚¨ãƒªã‚¢ã®30%ä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ï¼ˆã“ã“ã‚’å³ã—ãã™ã‚‹ã¨é›£æ˜“åº¦ãŒä¸ŠãŒã‚‹ï¼‰
            
            if (coverage > 0.5 && missRatio < 0.3) {
                showResult("ğŸ’®", "#ff3333");
            } else if (missRatio >= 0.3) {
                // ã¯ã¿å‡ºã—ã™ãã‚‹ã¨è­¦å‘Š
                // ã¾ã æ›¸ãé€”ä¸­ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€ã‚ã‹ã‚‰ã•ã¾ãªæ™‚ã ã‘å‡ºã™
                 if (coverage > 0.2) showResult("ã–ã¤ï¼", "#333");
            }
        }

        function showResult(text, color) {
            messageEl.innerText = text;
            messageEl.style.color = color;
            messageEl.style.opacity = 1;
            
            if(text === "ğŸ’®") {
                hasScored = true;
            } else {
                // å¤±æ•—è¡¨ç¤ºã¯ã™ãæ¶ˆã™
                setTimeout(() => {
                    if(!hasScored) messageEl.style.opacity = 0;
                }, 1000);
            }
        }

        function resetCanvas() {
            ctxDraw.clearRect(0, 0, 300, 300);
            messageEl.style.opacity = 0;
            hasScored = false;
        }

        function nextChar() {
            if (currentIndex < chars.length - 1) {
                currentIndex++;
                resetCanvas();
                drawGuide();
            }
        }
    </script>
</body>
</html>
