<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¯ãªã¾ã‚‹ç·´ç¿’å¸³</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            text-align: center;
            background-color: #f0f4f8;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        h1 { margin: 10px 0; color: #333; font-size: 1.5rem; }

        .canvas-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 10px;
        }

        #bgCanvas {
            z-index: 1;
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 4px solid #888;
        }

        #drawingCanvas {
            z-index: 2;
            cursor: crosshair;
        }

        /* ã¯ãªã¾ã‚‹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        #hanamaru {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 200px;
            color: #ff3333;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 2px 2px 0px #fff; 
        }

        #hanamaru.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button.secondary { background-color: #f44336; }
        
        /* åˆ¤å®šç”¨ã®è¦‹ãˆãªã„ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #checkCanvas { display: none; }
    </style>
</head>
<body>

    <h1>ã‹ãã‹ãŸã‚Œã‚“ã—ã‚…ã†</h1>
    <div style="margin-bottom:10px; font-weight:bold; color:#555;">ã¦ã„ã­ã„ã«ãªãã£ã¦ã­ï¼</div>

    <div class="canvas-wrapper">
        <canvas id="bgCanvas" width="300" height="300"></canvas>
        <canvas id="drawingCanvas" width="300" height="300"></canvas>
        <div id="hanamaru">ğŸ’®</div>
    </div>

    <canvas id="checkCanvas" width="300" height="300"></canvas>

    <div class="controls">
        <button class="secondary" onclick="resetCanvas()">ã‚¯ãƒªã‚¢</button>
        <button onclick="nextChar()">ã¤ãã¸ ï¼</button>
    </div>

    <script>
        const drawingCanvas = document.getElementById('drawingCanvas');
        const bgCanvas = document.getElementById('bgCanvas');
        const checkCanvas = document.getElementById('checkCanvas');
        
        const ctxDraw = drawingCanvas.getContext('2d');
        const ctxBg = bgCanvas.getContext('2d');
        const ctxCheck = checkCanvas.getContext('2d');
        
        const chars = ["ã‚","ã„","ã†","ãˆ","ãŠ","ã‹","ã","ã","ã‘","ã“"];
        let currentIndex = 0;
        let isDrawing = false;
        let hasScored = false; // ã™ã§ã«ã¯ãªã¾ã‚‹ãŒå‡ºãŸã‹

        // åˆæœŸåŒ–
        init();

        function init() {
            drawGuide();
            setupEvents();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupEvents() {
            // PC
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);

            // ã‚¹ãƒãƒ›
            drawingCanvas.addEventListener('touchstart', startDrawing, {passive: false});
            drawingCanvas.addEventListener('touchmove', draw, {passive: false});
            drawingCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            e.preventDefault();
            if(hasScored) return; // æ­£è§£å¾Œã¯æ›¸ã‹ã›ãªã„ï¼ˆå¥½ã¿ã§å¤‰æ›´å¯ï¼‰
            isDrawing = true;
            ctxDraw.beginPath();
            const pos = getPos(e);
            ctxDraw.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getPos(e);
            
            // æç”»ã‚¹ã‚¿ã‚¤ãƒ«
            ctxDraw.lineWidth = 25; // å¤ªã‚ã«ã™ã‚‹ï¼ˆåˆ¤å®šã—ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
            ctxDraw.lineCap = 'round';
            ctxDraw.lineJoin = 'round';
            ctxDraw.strokeStyle = 'rgba(0, 0, 0, 0.8)'; // å°‘ã—é€ã‘ã•ã›ã‚‹
            
            ctxDraw.lineTo(pos.x, pos.y);
            ctxDraw.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                checkResult(); // æ›¸ãçµ‚ã‚ã£ãŸã‚‰åˆ¤å®šï¼
            }
        }

        function getPos(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            return { x, y };
        }

        // ãŠæ‰‹æœ¬ã‚’æã
        function drawGuide() {
            const char = chars[currentIndex];
            
            // 1. èƒŒæ™¯ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆã‚‹è–„ã„æ–‡å­—ï¼‰
            ctxBg.clearRect(0,0,300,300);
            
            // åå­—ç·š
            ctxBg.strokeStyle = '#ddd';
            ctxBg.beginPath();
            ctxBg.setLineDash([5, 5]);
            ctxBg.moveTo(150, 0); ctxBg.lineTo(150, 300);
            ctxBg.moveTo(0, 150); ctxBg.lineTo(300, 150);
            ctxBg.stroke();

            // æ–‡å­—
            ctxBg.font = "200px 'KaiTi', 'Kyokasho', serif";
            ctxBg.fillStyle = "#e0e0e0";
            ctxBg.textAlign = "center";
            ctxBg.textBaseline = "middle";
            ctxBg.fillText(char, 150, 170);

            // 2. åˆ¤å®šç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆè£æ–¹ï¼šè¨ˆç®—ç”¨ï¼‰
            // ã“ã“ã«ã€Œæ­£è§£ã®å½¢ã€ã‚’èµ¤è‰²ã§æã„ã¦ãŠã
            ctxCheck.clearRect(0,0,300,300);
            ctxCheck.font = "200px 'KaiTi', 'Kyokasho', serif";
            ctxCheck.fillStyle = "#FF0000"; // èµ¤è‰²ã§æã
            ctxCheck.textAlign = "center";
            ctxCheck.textBaseline = "middle";
            ctxCheck.fillText(char, 150, 170);
        }

        // â˜…â˜…â˜… æ­£èª¤åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function checkResult() {
            if(hasScored) return;

            // 1. åˆ¤å®šç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆæ­£è§£ã®èµ¤æ–‡å­—ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const guideData = ctxCheck.getImageData(0, 0, 300, 300).data;
            // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ã„ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const userData = ctxDraw.getImageData(0, 0, 300, 300).data;

            let hitCount = 0;   // æ­£è§£ã‚¨ãƒªã‚¢ã«æ›¸ã„ãŸæ•°
            let guidePixels = 0; // æ­£è§£ã‚¨ãƒªã‚¢ã®ç·é¢ç©

            // å…¨ãƒ”ã‚¯ã‚»ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆ4ã¤é£›ã°ã—ã§é«˜é€ŸåŒ–ï¼‰
            for (let i = 0; i < guideData.length; i += 4 * 4) { // *4ã¯ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†
                // èµ¤è‰²æˆåˆ†ãŒã‚ã‚‹ï¼ãã“ã¯æ­£è§£ã‚¨ãƒªã‚¢
                if (guideData[i] > 100) { 
                    guidePixels++;
                    
                    // åŒã˜å ´æ‰€ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒä¸é€æ˜ï¼ˆæ›¸ã‹ã‚Œã¦ã„ã‚‹ï¼‰ã‹ï¼Ÿ
                    // userData[i+3] ã¯ã‚¢ãƒ«ãƒ•ã‚¡å€¤ï¼ˆé€æ˜åº¦ï¼‰
                    if (userData[i+3] > 50) {
                        hitCount++;
                    }
                }
            }

            // åˆ¤å®šåŸºæº–ï¼šæ­£è§£ã‚¨ãƒªã‚¢ã®ä½•ï¼…ã‚’å¡—ã£ãŸã‹
            // ã“ã“ã§ã¯50%ä»¥ä¸Šå¡—ã‚Œã°OKã¨ã—ã¦ã„ã¾ã™ï¼ˆå­ä¾›å‘ã‘ã«ç”˜ã‚ã«ï¼‰
            const ratio = hitCount / guidePixels;
            
            console.log("ã‚«ãƒãƒ¼ç‡: " + Math.floor(ratio * 100) + "%");

            if (ratio > 0.55) {
                showHanamaru();
            }
        }

        function showHanamaru() {
            const el = document.getElementById('hanamaru');
            el.classList.add('show');
            hasScored = true;
            // ãŠç¥ã„ã®åŠ¹æœéŸ³ã‚’ã“ã“ã«å…¥ã‚Œã‚‹ã“ã¨ã‚‚å¯èƒ½
        }

        function resetCanvas() {
            ctxDraw.clearRect(0, 0, 300, 300);
            document.getElementById('hanamaru').classList.remove('show');
            hasScored = false;
        }

        function nextChar() {
            if (currentIndex < chars.length - 1) {
                currentIndex++;
                resetCanvas();
                drawGuide();
            }
        }
    </script>
</body>
</html>
