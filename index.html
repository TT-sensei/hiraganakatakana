<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‹ãªãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Kosugi+Maru:wght@400;700&display=swap');

        :root {
            /* ã‹ãªç‰ˆå‘ã‘ã«å°‘ã—ãƒ‘ã‚¹ãƒ†ãƒ«ã§å„ªã—ã„è‰²å‘³ã«å¤‰æ›´ */
            --primary: #FF6B6B;      /* ã²ã‚‰ãŒãªèµ¤ */
            --secondary: #4ECDC4;    /* ã‚«ã‚¿ã‚«ãƒŠé’ç·‘ */
            --accent: #45B7D1;       /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆé’ */
            --accent2: #FFE66D;      /* æ˜Ÿã®è‰² */
            --accent3: #FF8C42;      /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            --bg-light: #FFF9F9;
            --text: #4A4A4A;
            --shadow-pop: 0 8px 0 rgba(0,0,0,0.15);
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.08);
        }

        html, body {
            font-family: 'Kosugi Maru', sans-serif;
            background: linear-gradient(135deg, #FFF0F5 0%, #E0F7FA 100%);
            color: var(--text);
            margin: 0;
            padding: 0;
            text-align: center;
            user-select: none;
            overflow-x: hidden;
            touch-action: manipulation;
            width: 100%;
            height: 100%;
        }

        /* ç”»é¢å…±é€šè¨­å®š */
        .screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
            animation: fadeIn 0.3s;
        }
        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        #title-screen {
            padding-top: 40px;
            padding-bottom: 50px;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-backgroundã‹ã‚“ãœãœãƒ¼ã§ã‚‹ãŸãŸ-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            font-weight: 700;
            letter-spacing: 2px;
            line-height: 1.4;
        }

        .mascot-area {
            font-size: 6rem;
            margin: 20px 0;
            animation: bounce 2s infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        .menu-btn {
            display: block;
            width: 85%;
            max-width: 320px;
            margin: 12px auto;
            padding: 18px;
            font-size: 1.4rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: var(--shadow-pop);
            transition: all 0.1s;
            font-family: inherit;
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }

        .menu-btn:active {
            transform: translateY(7px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        .btn-practice { 
            background: linear-gradient(135deg, #4ECDC4, #26A69A);
            color: white;
        }
        .btn-test { 
            background: linear-gradient(135deg, #FF6B6B, #FF5252);
            color: white;
        }
        
        /* ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠãƒœã‚¿ãƒ³ï¼ˆã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠï¼‰ */
        .grade-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 25px auto;
            flex-wrap: wrap;
            max-width: 360px;
        }
        .grade-btn {
            width: 100px;
            height: 80px;
            border-radius: 15px;
            border: 4px solid white;
            background: rgba(255,255,255,0.6);
            color: var(--text);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            font-family: inherit;
            box-shadow: var(--shadow-soft);
        }
        .grade-btn-icon {
            font-size: 1.8rem;
        }
        .grade-btn.selected {
            background: white;
            transform: scale(1.1) rotateZ(-2deg);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
        }
        /* ã‚«ã‚¿ã‚«ãƒŠåˆ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .grade-btn.katakana.selected {
            border-color: var(--secondary);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);
        }

        .home-search-box {
            margin: 20px auto;
            width: 85%;
            max-width: 340px;
            display: flex;
            gap: 8px;
            box-sizing: border-box;
        }
        .home-search-box input {
            flex: 1;
            padding: 12px;
            border-radius: 25px;
            border: 3px solid white;
            font-size: 1rem;
            text-align: center;
            background: white;
            box-shadow: var(--shadow-soft);
            color: var(--text);
            font-family: inherit;
            box-sizing: border-box;
            min-width: 0;
        }
        .home-search-box button {
            background: linear-gradient(135deg, var(--accent), #29B6F6);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: var(--shadow-pop);
            font-family: inherit;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .home-search-box button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer-note {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text);
            border-radius: 20px;
            font-size: 0.85rem;
            width: 90%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
            box-shadow: var(--shadow-soft);
        }

        /* ãƒªã‚¹ãƒˆç”»é¢ */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            border: 3px solid white;
        }

        .back-btn {
            background: linear-gradient(135deg, #9E9E9E, #B0BEC5);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
            font-family: inherit;
        }

        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
            padding-bottom: 50px;
        }

        .kanji-card {
            background: white;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border-radius: 18px;
            box-shadow: var(--shadow-pop);
            cursor: pointer;
            position: relative;
            border: 3px solid transparent;
            transition: all 0.1s;
            font-weight: 700;
        }
        .kanji-card:active { 
            transform: scale(0.92);
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        
        .kanji-card.cleared-practice { 
            border-color: var(--secondary);
            background: linear-gradient(135deg, #E0F2F1, #B2DFDB);
        }
        .kanji-card.cleared-test { 
            border-color: var(--primary);
            background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
        }

        .mark-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .cleared-practice .star-mark { background: var(--accent2); border-radius:50%; width:100%; height:100%; display:flex; justify-content:center; align-items:center; }
        .cleared-test .crown-mark { background: var(--primary); color:white; border-radius:50%; width:100%; height:100%; display:flex; justify-content:center; align-items:center; }

        /* ç·´ç¿’ç”»é¢ */
        #practice-area {
            background: white;
            border-radius: 25px;
            padding: 20px;
            box-shadow: var(--shadow-soft);
            display: inline-block;
            margin-top: 20px;
            border: 4px solid white;
        }

        .controls {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .control-btn {
            background: linear-gradient(135deg, var(--accent), #29B6F6);
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: var(--shadow-pop);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:nth-child(2) {
            background: linear-gradient(135deg, var(--accent3), #FF7043);
        }
        .control-btn:active {
            transform: translateY(7px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        /* ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤ãƒãƒ¼ */
        .xp-container {
            width: 90%;
            max-width: 420px;
            height: 24px;
            background: white;
            border-radius: 15px;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            border: 3px solid #E0E0E0;
        }
        .xp-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), #26A69A);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆçµæœãªã©ï¼‰ */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            backdrop-filter: blur(4px);
        }
        .overlay.active { display: flex; animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .result-content {
            background: white;
            color: var(--text);
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 4px solid white;
        }
        .big-icon { font-size: 6rem; margin: 15px 0; }
        
        .next-btn {
            background: linear-gradient(135deg, var(--primary), #FF5252);
            color: white;
            border: none;
            padding: 16px 36px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: var(--shadow-pop);
            font-weight: 700;
            font-family: inherit;
        }
        .next-btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }
        .retry-btn {
            background: none;
            border: 2px solid #DDD;
            color: #999;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            font-family: inherit;
        }

        /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ç‰¹åˆ¥æ¼”å‡º */
        #levelup-overlay { background: rgba(255, 107, 107, 0.95); }
        .levelup-anim { font-size: 7rem; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(3px);
        }
        .confirm-modal.active { display: flex; }
        .confirm-content {
            background: white;
            color: var(--text);
            padding: 35px;
            border-radius: 25px;
            text-align: center;
            width: 85%;
            max-width: 300px;
        }
        .confirm-btn {
            width: 100%;
            padding: 14px;
            margin-top: 12px;
            border: none;
            border-radius: 18px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 700;
            box-shadow: var(--shadow-pop);
        }
        .confirm-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        .confirm-btn-yes { background: linear-gradient(135deg, #FF6B6B, #FF5252); color: white; }
        .confirm-btn-no { background: linear-gradient(135deg, #B0BEC5, #90A4AE); color: white; }

        #mode-display {
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            font-size: 0.95rem;
            font-weight: 700;
            box-shadow: var(--shadow-soft);
            display: inline-block;
        }

        #message-area {
            margin: 15px 0;
            font-size: 1.3rem;
            font-weight: 700;
            min-height: 30px;
        }

        .reset-link { margin-top: 20px; font-size: 0.85rem; }
        .reset-link span { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: 700; }
  </style>
 </head>
 <body>
  <div id="title-screen" class="screen active">
   <h1>ğŸ“› ã‹ãªãƒã‚¹ã‚¿ãƒ¼</h1>
   <div class="mascot-area" id="title-mascot">
    ğŸ¥š
   </div>
   <div style="font-size:1.3rem; margin-bottom:15px; font-weight:700;">
    Lv.<span id="title-level">1</span>
   </div>
   
   <div class="grade-selector">
        <button class="grade-btn selected" onclick="setGroup(1)">
            <div class="grade-btn-icon">ã‚</div>
            <div>ã‚ï½ã¨</div>
        </button> 
        <button class="grade-btn" onclick="setGroup(2)">
            <div class="grade-btn-icon">ãª</div>
            <div>ãªï½ã‚“</div>
        </button> 
        <button class="grade-btn" onclick="setGroup(3)">
            <div class="grade-btn-icon">ã‚›</div>
            <div>ã ããŠã‚“</div>
        </button> 
        <button class="grade-btn katakana" onclick="setGroup(4)">
            <div class="grade-btn-icon">ã‚¢</div>
            <div>ã‚¢ï½ãƒˆ</div>
        </button> 
        <button class="grade-btn katakana" onclick="setGroup(5)">
            <div class="grade-btn-icon">ãƒŠ</div>
            <div>ãƒŠï½ãƒ³</div>
        </button> 
        <button class="grade-btn katakana" onclick="setGroup(6)">
            <div class="grade-btn-icon">ã‚›</div>
            <div>ãƒ€ã‚¯ã‚ªãƒ³</div>
        </button>
   </div>

   <div class="home-search-box">
       <input type="text" id="home-search-input" placeholder="ã•ãŒã—ãŸã„ ã‚‚ã˜"> 
       <button onclick="handleHomeSearch()">ğŸ”</button>
   </div>
   
   <button class="menu-btn btn-practice" onclick="selectMode('practice')">âœï¸ ã‚Œã‚“ã—ã‚…ã†</button> 
   <button class="menu-btn btn-test" onclick="selectMode('test')">ğŸ… ãƒ†ã‚¹ãƒˆ</button>
   
   <div class="reset-link"><span onclick="showResetConfirm()">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</span></div>
   
   <div class="footer-note">
     <strong>âš ï¸ ä¿è­·è€…ã®æ–¹ã¸</strong><br>
     æ›¸ãé †ï¼ˆç­†é †ï¼‰ã¯ä¸€èˆ¬çš„ãªå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€å­¦æ ¡ã®æŒ‡å°æ–¹é‡ã¨ç•°ãªã‚‹å ´åˆã¯ã€å­¦æ ¡ã®æŒ‡å°ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚<br>
     â€»æ¿éŸ³ï¼ˆãŒãƒ»ã±ï¼‰ãªã©ã‚‚ç·´ç¿’ã§ãã¾ã™ã€‚
   </div>
  </div>

  <div id="list-screen" class="screen">
   <div class="header-bar">
       <button class="back-btn" onclick="showScreen('title-screen')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
       <div style="font-weight:700; font-size:1.1rem;"><span id="list-mascot">ğŸ¥š</span> Lv.<span id="list-level">1</span></div>
   </div>
   <div class="xp-container"><div class="xp-bar" id="xp-bar"></div></div>
   <div style="text-align:right; font-size:0.85rem; margin-bottom:12px; color:#666; font-weight:600;">
    ã¤ãã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ã‚ã¨ <span id="next-xp">5</span>ã“
   </div>
   <div style="text-align:center; margin-bottom:20px;">
       <input type="text" id="search-box" placeholder="ã‚‚ã˜ ã‚’ ã•ãŒã™..." oninput="filterList()" style="padding:10px; border-radius:20px; border:2px solid #ddd; width:60%;">
   </div>
   <div style="margin-bottom:15px; display:flex; justify-content:center;"><span id="mode-display"></span></div>
   <div id="kanji-grid" class="kanji-grid"></div>
  </div>

  <div id="practice-screen" class="screen">
    <div class="header-bar">
      <button class="back-btn" onclick="showScreen('list-screen')">â†© ã‚‚ã©ã‚‹</button>
    </div>
    <h2 id="message-area"></h2>
    <div id="current-reading" style="font-size:2rem; font-weight:bold; text-align:center; margin:5px 0; color:#888;"></div>
    <div id="practice-area">
      <div id="character-target"></div>
    </div>
    <div class="controls">
      <button class="control-btn" onclick="writer.animateCharacter()">â–¶</button> 
      <button class="control-btn" onclick="retry()">â†º</button>
    </div>
  </div>

  <div id="result-overlay" class="overlay">
   <div class="result-content">
    <div class="big-icon" id="result-icon">â­</div>
    <h2 id="result-msg">ã§ããŸï¼</h2>
    <button class="next-btn" onclick="document.getElementById('result-overlay').classList.remove('active'); goNext();">ã¤ãã¸ âœ</button> 
    <button class="retry-btn" onclick="document.getElementById('result-overlay').classList.remove('active'); retry();">ã‚‚ã†ã„ã£ã‹ã„</button>
   </div>
  </div>

  <div id="levelup-overlay" class="overlay">
   <div class="result-content">
    <h2 style="font-size:2.5rem;">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ï¼</h2>
    <div class="levelup-anim">âœ¨</div>
    <div style="font-size:1.6rem; margin:15px 0; font-weight:700;">Lv.<span id="new-level-num">2</span> ã«ãªã£ãŸï¼</div>
    <div style="font-size:5rem; margin:20px 0;" id="levelup-mascot">ğŸ£</div>
    <p style="font-size:1rem; margin:15px 0;">ã™ã”ã„ãï¼<br>ã‚ãŸã‚‰ã—ã„ ãªã‹ã¾ ã ï¼</p>
    <button class="next-btn" onclick="closeLevelUp()">ğŸ‰ ã‚„ã£ãŸãƒ¼ï¼</button>
   </div>
  </div>

  <div id="reset-confirm" class="confirm-modal">
   <div class="confirm-content">
    <h3 style="font-size:1.2rem;">ã»ã‚“ã¨ã†ã« ãƒ‡ãƒ¼ã‚¿ã‚’ ã‘ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p style="color:#666;">ãƒ¬ãƒ™ãƒ«ã‚‚ï¼‘ã« ã‚‚ã©ã‚Šã¾ã™ã€‚</p>
    <button class="confirm-btn confirm-btn-yes" onclick="executeReset()">ã¯ã„ã€ã‘ã—ã¾ã™</button> 
    <button class="confirm-btn confirm-btn-no" onclick="closeResetConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
   </div>
  </div>

  <script>
        // --- ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        // 1: ã²ã‚‰ãŒãª(ã‚-ã¨), 2: ã²ã‚‰ãŒãª(ãª-ã‚“), 3: ã²ã‚‰ãŒãªæ¿éŸ³
        // 4: ã‚«ã‚¿ã‚«ãƒŠ(ã‚¢-ãƒˆ), 5: ã‚«ã‚¿ã‚«ãƒŠ(ãƒŠ-ãƒ³), 6: ã‚«ã‚¿ã‚«ãƒŠæ¿éŸ³
        const kanaDataString = {
            1: "ã‚:ã‚|ã„:ã„|ã†:ã†|ãˆ:ãˆ|ãŠ:ãŠ|ã‹:ã‹|ã:ã|ã:ã|ã‘:ã‘|ã“:ã“|ã•:ã•|ã—:ã—|ã™:ã™|ã›:ã›|ã:ã|ãŸ:ãŸ|ã¡:ã¡|ã¤:ã¤|ã¦:ã¦|ã¨:ã¨",
            2: "ãª:ãª|ã«:ã«|ã¬:ã¬|ã­:ã­|ã®:ã®|ã¯:ã¯|ã²:ã²|ãµ:ãµ|ã¸:ã¸|ã»:ã»|ã¾:ã¾|ã¿:ã¿|ã‚€:ã‚€|ã‚:ã‚|ã‚‚:ã‚‚|ã‚„:ã‚„|ã‚†:ã‚†|ã‚ˆ:ã‚ˆ|ã‚‰:ã‚‰|ã‚Š:ã‚Š|ã‚‹:ã‚‹|ã‚Œ:ã‚Œ|ã‚:ã‚|ã‚:ã‚|ã‚’:ã‚’|ã‚“:ã‚“",
            3: "ãŒ:ãŒ|ã:ã|ã:ã|ã’:ã’|ã”:ã”|ã–:ã–|ã˜:ã˜|ãš:ãš|ãœ:ãœ|ã:ã|ã :ã |ã¢:ã¢|ã¥:ã¥|ã§:ã§|ã©:ã©|ã°:ã°|ã³:ã³|ã¶:ã¶|ã¹:ã¹|ã¼:ã¼|ã±:ã±|ã´:ã´|ã·:ã·|ãº:ãº|ã½:ã½",
            4: "ã‚¢:ã‚¢|ã‚¤:ã‚¤|ã‚¦:ã‚¦|ã‚¨:ã‚¨|ã‚ª:ã‚ª|ã‚«:ã‚«|ã‚­:ã‚­|ã‚¯:ã‚¯|ã‚±:ã‚±|ã‚³:ã‚³|ã‚µ:ã‚µ|ã‚·:ã‚·|ã‚¹:ã‚¹|ã‚»:ã‚»|ã‚½:ã‚½|ã‚¿:ã‚¿|ãƒ:ãƒ|ãƒ„:ãƒ„|ãƒ†:ãƒ†|ãƒˆ:ãƒˆ",
            5: "ãƒŠ:ãƒŠ|ãƒ‹:ãƒ‹|ãƒŒ:ãƒŒ|ãƒ:ãƒ|ãƒ:ãƒ|ãƒ:ãƒ|ãƒ’:ãƒ’|ãƒ•:ãƒ•|ãƒ˜:ãƒ˜|ãƒ›:ãƒ›|ãƒ:ãƒ|ãƒŸ:ãƒŸ|ãƒ :ãƒ |ãƒ¡:ãƒ¡|ãƒ¢:ãƒ¢|ãƒ¤:ãƒ¤|ãƒ¦:ãƒ¦|ãƒ¨:ãƒ¨|ãƒ©:ãƒ©|ãƒª:ãƒª|ãƒ«:ãƒ«|ãƒ¬:ãƒ¬|ãƒ­:ãƒ­|ãƒ¯:ãƒ¯|ãƒ²:ãƒ²|ãƒ³:ãƒ³",
            6: "ã‚¬:ã‚¬|ã‚®:ã‚®|ã‚°:ã‚°|ã‚²:ã‚²|ã‚´:ã‚´|ã‚¶:ã‚¶|ã‚¸:ã‚¸|ã‚º:ã‚º|ã‚¼:ã‚¼|ã‚¾:ã‚¾|ãƒ€:ãƒ€|ãƒ‚:ãƒ‚|ãƒ…:ãƒ…|ãƒ‡:ãƒ‡|ãƒ‰:ãƒ‰|ãƒ:ãƒ|ãƒ“:ãƒ“|ãƒ–:ãƒ–|ãƒ™:ãƒ™|ãƒœ:ãƒœ|ãƒ‘:ãƒ‘|ãƒ”:ãƒ”|ãƒ—:ãƒ—|ãƒš:ãº|ãƒ:ãƒ"
        };

        function parseData(str) {
            return str.split('|').map(s => {
                const [c, r] = s.split(':');
                return { char: c, reading: r };
            });
        }

        const allData = {};
        for(let g=1; g<=6; g++) {
            if(kanaDataString[g]) allData[g] = parseData(kanaDataString[g]);
        }

        // --- éŸ³å£° (Oscillator) ---
        let audioContext;
        function playSound(type) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioContext.currentTime;
            
            const createOsc = (freq, type, dur, vol = 0.1) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, now);
                gain.gain.setValueAtTime(vol, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + dur);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start(now);
                osc.stop(now + dur);
            };

            switch(type) {
                case 'success': createOsc(880, 'sine', 0.2); break;
                case 'click': createOsc(600, 'triangle', 0.1, 0.05); break;
                case 'error': createOsc(200, 'sawtooth', 0.3, 0.1); break;
                case 'complete': 
                    createOsc(600, 'sine', 0.1); 
                    setTimeout(() => createOsc(1200, 'sine', 0.3), 100);
                    break;
                case 'levelup': 
                    // ã‚­ãƒ©ã‚­ãƒ©éŸ³
                    [523,659,783,1046,1318,1568].forEach((f,i)=> {
                         setTimeout(()=> createOsc(f,'sine',0.4,0.1), i*80);
                    });
                    break;
            }
        }

        // --- çŠ¶æ…‹ç®¡ç† ---
        let progressPractice = JSON.parse(localStorage.getItem('kanaMasterPractice')) || {};
        let progressTest = JSON.parse(localStorage.getItem('kanaMasterTest')) || {};
        let writer;
        let currentChar = null;
        let currentMode = 'practice';
        let currentGroup = 1; // 1-6
        const XP_PER_LEVEL = 5;

        // --- UIæ›´æ–° ---
        function getStats() {
            const pCount = Object.keys(progressPractice).length;
            const tCount = Object.keys(progressTest).length;
            const totalXP = pCount + (tCount * 2);
            
            const level = Math.floor(totalXP / XP_PER_LEVEL) + 1;
            const currentLevelXP = totalXP % XP_PER_LEVEL;
            const nextLevelXP = XP_PER_LEVEL - currentLevelXP;
            return { level, totalXP, currentLevelXP, nextLevelXP };
        }

        function getMascot(level) {
            const list = ["ğŸ¥š ã‚¿ãƒã‚´", "ğŸ£ ãƒ’ãƒ¨ã‚³", "ğŸ¥ ã‚¢ãƒ’ãƒ«", "ğŸ¦‰ ãƒ•ã‚¯ãƒ­ã‚¦", "ğŸ¦œ ã‚¤ãƒ³ã‚³", "ğŸ‡ ã‚¦ã‚µã‚®", "ğŸˆ ãƒã‚³", "ğŸ• ã‚¤ãƒŒ", "ğŸ¼ ãƒ‘ãƒ³ãƒ€", "ğŸ¦ ãƒ©ã‚¤ã‚ªãƒ³", "ğŸ‰ ãƒ‰ãƒ©ã‚´ãƒ³", "ğŸ¦„ ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", "ğŸ‘‘ ç‹æ§˜", "ğŸš€ ãƒ­ã‚±ãƒƒãƒˆ", "ğŸŒ ã‚¿ã‚¤ãƒ¨ã‚¦", "ğŸŒŒ ã‚¦ãƒãƒ¥ã‚¦"];
            return list[Math.min(Math.floor(level/5), list.length-1)];
        }

        function updateUI() {
            const stats = getStats();
            const mascot = getMascot(stats.level);
            
            document.getElementById('title-mascot').innerText = mascot.split(' ')[0];
            document.getElementById('title-level').innerText = stats.level;
            document.getElementById('list-mascot').innerText = mascot.split(' ')[0];
            document.getElementById('list-level').innerText = stats.level;
            document.getElementById('next-xp').innerText = stats.nextLevelXP;
            
            const percent = (stats.currentLevelXP / XP_PER_LEVEL) * 100;
            document.getElementById('xp-bar').style.width = `${percent}%`;
        }

        function setGroup(g) {
            playSound('click');
            currentGroup = g;
            updateGroupButtons();
        }

        function updateGroupButtons() {
            document.querySelectorAll('.grade-btn').forEach((btn, idx) => {
                // idxã¯0å§‹ã¾ã‚Šã€groupã¯1å§‹ã¾ã‚Š
                btn.classList.toggle('selected', (idx + 1) === currentGroup);
            });
        }

        function showScreen(id) {
            window.scrollTo(0,0);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if(id === 'list-screen') renderList();
            if(id === 'title-screen') {
                updateGroupButtons();
                updateUI();
                document.getElementById('home-search-input').value = '';
                document.getElementById('search-box').value = '';
            }
        }

        function selectMode(m) {
            playSound('click');
            currentMode = m;
            document.getElementById('search-box').value = '';
            showScreen('list-screen');
        }

        function handleHomeSearch() {
            const v = document.getElementById('home-search-input').value;
            if(!v) return;
            document.getElementById('search-box').value = v;
            currentMode = 'practice';
            playSound('click');
            showScreen('list-screen');
            filterList();
        }

        function filterList() { renderList(); }

        function renderList() {
            updateUI();
            const search = document.getElementById('search-box').value.trim();
            const grid = document.getElementById('kanji-grid');
            const badge = document.getElementById('mode-display');
            
            // ãƒãƒƒã‚¸è¡¨ç¤º
            let groupName = "";
            if(currentGroup <= 2) groupName = "ã²ã‚‰ãŒãªãƒ»ãã»ã‚“";
            else if(currentGroup === 3) groupName = "ã²ã‚‰ãŒãªãƒ»ã ããŠã‚“";
            else if(currentGroup <= 5) groupName = "ã‚«ã‚¿ã‚«ãƒŠãƒ»ãã»ã‚“";
            else groupName = "ã‚«ã‚¿ã‚«ãƒŠãƒ»ã ããŠã‚“";

            if (search) groupName = "ã‘ã‚“ã•ãã‘ã£ã‹";

            if(currentMode === 'practice') {
                badge.innerText = `âœï¸ ${groupName} ã‚Œã‚“ã—ã‚…ã†`;
                badge.style.background = 'var(--secondary)';
            } else {
                badge.innerText = `ğŸ… ${groupName} ãƒ†ã‚¹ãƒˆ`;
                badge.style.background = 'var(--primary)';
            }

            grid.innerHTML = '';
            let targetList = [];

            if(search) {
                for(let g=1; g<=6; g++) {
                    const hits = allData[g].filter(d => d.char.includes(search));
                    hits.forEach(h => h._grp = g);
                    targetList = targetList.concat(hits);
                }
            } else {
                targetList = allData[currentGroup] || [];
                targetList.forEach(h => h._grp = currentGroup);
            }

            const targetStorage = (currentMode === 'practice') ? progressPractice : progressTest;

            if(targetList.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; padding:20px; color:#999;">ã¿ã¤ã‹ã‚Šã¾ã›ã‚“...</div>';
                return;
            }

            targetList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'kanji-card';
                if(targetStorage[item.char]) {
                    card.classList.add(currentMode === 'practice' ? 'cleared-practice' : 'cleared-test');
                }
                
                let marks = "";
                if(progressPractice[item.char]) marks += `<div class="mark-badge cleared-practice" style="right:auto; left:-8px;"><span class="star-mark">â­</span></div>`;
                if(progressTest[item.char]) marks += `<div class="mark-badge cleared-test"><span class="crown-mark">ğŸ‘‘</span></div>`;

                card.innerHTML = `${item.char}${marks}`;
                card.onclick = () => {
                    playSound('click');
                    if(item._grp) currentGroup = item._grp;
                    startApp(item);
                };
                grid.appendChild(card);
            });
        }

        // --- æ›¸ãå–ã‚Šãƒ­ã‚¸ãƒƒã‚¯ ---
        function startApp(item) {
            currentChar = item;
            showScreen('practice-screen');
            document.getElementById('result-overlay').classList.remove('active');
            
            const msg = document.getElementById('message-area');
            const read = document.getElementById('current-reading');

            if(currentMode === 'test') {
                msg.innerText = "ã“ã® ã‚‚ã˜ ã‚’ ã‹ã“ã†ï¼";
                msg.style.color = "var(--primary)";
                read.innerText = "ï¼Ÿ"; // ãƒ†ã‚¹ãƒˆãªã®ã§éš ã™ï¼ˆéŸ³å£°èª­ã¿ä¸Šã’ãŒã‚ã‚Œã°ãƒ™ã‚¹ãƒˆã ãŒä»Šå›ã¯æ–‡å­—ã®ã¿ï¼‰
                // å®Ÿéš›ã¯ã‹ãªã®å ´åˆã€Œèª­ã¿ã€ï¼ã€Œæ–‡å­—ãã®ã‚‚ã®ã€ãªã®ã§ã€ãƒ†ã‚¹ãƒˆã§ã€Œã‚ã€ã¨å‡ºã—ã¦ã€Œã‚ã€ã‚’æ›¸ãã®ã¯è¦–å†™ã«ãªã‚‹ã€‚
                // å·¥å¤«ï¼šãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€Œã‚ã€ã‚’è¡¨ç¤ºã—ã¦ã€Œãã‚Œã„ã«æ›¸ãã€ãƒ†ã‚¹ãƒˆã¨ã™ã‚‹ã‹ã€
                // ã‚ã‚‹ã„ã¯ã€Œã‚ã€ã‚’æ¶ˆã—ã¦ã€éŸ³å£°ãŒãªã„ã¨æˆç«‹ã—ãªã„ãŒ...
                // â†’ ä»Šå›ã¯ã€Œè¦–å†™ï¼ˆãªãã‚Šãªã—ï¼‰ã€ã‚’ãƒ†ã‚¹ãƒˆã¨å®šç¾©ã—ã¾ã™ã€‚
                read.innerText = item.char; 
            } else {
                msg.innerText = "ãªãã£ã¦ã¿ã‚ˆã†ï¼";
                msg.style.color = "var(--secondary)";
                read.innerText = item.char;
            }

            document.getElementById('character-target').innerHTML = '';
            
            // HanziWriterè¨­å®š
            writer = HanziWriter.create('character-target', item.char, {
                width: 280, height: 280, padding: 10,
                showOutline: (currentMode === 'practice'), // ãƒ†ã‚¹ãƒˆæ™‚ã¯ã‚¬ã‚¤ãƒ‰ãªã—
                strokeAnimationSpeed: 1,
                delayBetweenStrokes: 200,
                radicalColor: '#4ECDC4',
                drawingWidth: 25,
                outlineColor: '#DDD',
                strokeColor: '#333',
                highlightColor: '#FF8C42',
                showHintAfterMisses: 2,
                charDataLoader: (char, onComplete) => {
                    // æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨
                    fetch(`https://cdn.jsdelivr.net/gh/chanind/hanzi-writer-data-jp@master/data/${char}.json`)
                    .then(r => r.json()).then(onComplete)
                    .catch(() => {
                        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä¸»ã«æ¿ç‚¹ãªã©ç‰¹æ®Šæ–‡å­—ç”¨ï¼‰
                        console.log("Data not found for: " + char);
                    });
                }
            });

            writer.quiz({
                onMistake: () => { 
                    playSound('error'); 
                    document.getElementById('message-area').innerText = "ãŠã—ã„ï¼";
                },
                onCorrectStroke: () => { 
                    playSound('success'); 
                    document.getElementById('message-area').innerText = "ã„ã„ãï¼";
                },
                onComplete: handleComplete
            });
        }

        function handleComplete() {
            playSound('complete');
            const isPractice = (currentMode === 'practice');
            const storage = isPractice ? progressPractice : progressTest;
            const key = isPractice ? 'kanaMasterPractice' : 'kanaMasterTest';
            
            const firstTime = !storage[currentChar.char];
            storage[currentChar.char] = true;
            localStorage.setItem(key, JSON.stringify(storage));

            const msg = document.getElementById('result-msg');
            const icon = document.getElementById('result-icon');
            
            if(isPractice) {
                msg.innerText = "ã˜ã‚‡ã†ãšï¼";
                msg.style.color = "var(--secondary)";
                icon.innerText = "â­";
            } else {
                msg.innerText = "ã‹ã‚“ãºãï¼";
                msg.style.color = "var(--primary)";
                icon.innerText = "ğŸ‘‘";
            }

            setTimeout(() => {
                document.getElementById('result-overlay').classList.add('active');
                if(firstTime) checkLevelUp();
            }, 800);
        }

        function checkLevelUp() {
            const stats = getStats();
            if(stats.totalXP > 0 && stats.totalXP % XP_PER_LEVEL === 0) {
                setTimeout(() => {
                    playSound('levelup');
                    document.getElementById('result-overlay').classList.remove('active');
                    document.getElementById('levelup-overlay').classList.add('active');
                    document.getElementById('new-level-num').innerText = stats.level;
                    document.getElementById('levelup-mascot').innerText = getMascot(stats.level).split(' ')[0];
                }, 1000);
            }
        }

        function closeLevelUp() {
            document.getElementById('levelup-overlay').classList.remove('active');
            goNext();
        }

        function goNext() {
            const list = allData[currentGroup];
            if(!list) { showScreen('list-screen'); return; }
            
            const idx = list.findIndex(d => d.char === currentChar.char);
            if(idx >= 0 && idx < list.length - 1) {
                startApp(list[idx+1]);
            } else {
                showScreen('list-screen');
            }
        }

        function retry() { startApp(currentChar); }

        function showResetConfirm() { playSound('click'); document.getElementById('reset-confirm').classList.add('active'); }
        function closeResetConfirm() { playSound('click'); document.getElementById('reset-confirm').classList.remove('active'); }
        function executeReset() {
            playSound('click');
            localStorage.removeItem('kanaMasterPractice');
            localStorage.removeItem('kanaMasterTest');
            progressPractice = {};
            progressTest = {};
            location.reload();
        }

        // åˆæœŸåŒ–
        updateUI();
  </script>
 </body>
</html>
